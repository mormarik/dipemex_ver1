// server.js

const express = require('express');
const path = require('path');
const fs = require('fs');
const session = require('express-session');
const mongoose = require('mongoose');
const MongoStore = require('connect-mongo');
const cors = require('cors');
const multer = require('multer');
const bcrypt = require('bcryptjs');

const User = require('./models/user');
const Product = require('./models/product');
const Order = require('./models/order');

const app = express();
const port = 3000;

// === ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MongoDB === //
mongoose.connect('mongodb://localhost:27017/your-database', {
  useNewUrlParser: true,
  useUnifiedTopology: true,
})
.then(() => console.log('âœ… MongoDB Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾'))
.catch(err => console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº MongoDB:', err));

// === ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ === //
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadsDir = path.join(__dirname, 'uploads');
    if (!fs.existsSync(uploadsDir)) fs.mkdirSync(uploadsDir);
    cb(null, uploadsDir);
  },
  filename: (req, file, cb) => {
    cb(null, Date.now() + path.extname(file.originalname));
  }
});

function checkFileType(file, cb) {
  const allowedTypes = /jpeg|jpg|png|svg/;
  const extname = path.extname(file.originalname).toLowerCase();
  const mimetype = file.mimetype;

  if (allowedTypes.test(extname) && allowedTypes.test(mimetype.split('/')[1])) {
    return cb(null, true);
  }

  cb(new Error('Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ: .png, .jpg, .jpeg, .svg'));
}

const upload = multer({
  storage,
  limits: { fileSize: 10 * 1024 * 1024 }, // Ð´Ð¾ 10MB
  fileFilter: function (req, file, cb) {
    checkFileType(file, cb);
  }
});

// === Middleware === //
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// === CORS === //
app.use(cors({
  origin: 'http://localhost:3000',
  credentials: true
}));

// === Session middleware === //
app.use(session({
  secret: 'mySuperSecretKey12345!#',
  resave: false,
  saveUninitialized: false,
  store: MongoStore.create({ mongoUrl: 'mongodb://localhost:27017/emex-project' }), // Ð¸Ð»Ð¸ URI Ñ‚Ð²Ð¾ÐµÐ¹ Ð‘Ð”
  cookie: {
    maxAge: 24 * 60 * 60 * 1000, // 24 Ñ‡Ð°ÑÐ°
    secure: false, // true, ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑˆÑŒ HTTPS
    httpOnly: true,
    sameSite: 'lax'
  },
  name: 'sid'
}));

// === Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ === //
app.use(express.static(path.join(__dirname, '../frontend')));
app.use('/api/uploads', express.static(path.join(__dirname, 'uploads')));

// === Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ === //
app.post('/api/register', async (req, res) => {
  const { username, email, password } = req.body;
  if (!username || !email || !password) {
    return res.status(400).json({ success: false, message: "Ð’ÑÐµ Ð¿Ð¾Ð»Ñ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹" });
  }

  try {
    const existingUser = await User.findOne({ $or: [{ email }, { username }] });
    if (existingUser) {
      return res.status(400).json({ success: false, message: "Email Ð¸Ð»Ð¸ username ÑƒÐ¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ" });
    }

    const hashedPassword = await bcrypt.hash(password, 10);
    const role = (username === 'admin' && email === 'admin@yandex.ru') ? 'admin' : 'user';

    const newUser = new User({ username, email, password: hashedPassword, role });
    await newUser.save();

    req.session.userId = newUser._id;
    req.session.user = {
      username: newUser.username,
      email: newUser.email,
      role: newUser.role
    };

    console.log("âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½:", req.session.user);

    res.status(200).json({
      success: true,
      user: {
        username: newUser.username,
        email: newUser.email,
        role: newUser.role
      }
    });
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸:', err);
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// === Ð’Ñ…Ð¾Ð´ === //
app.post('/api/login', async (req, res) => {
  const { email, password } = req.body;

  try {
    const user = await User.findOne({ email });
    if (!user) return res.status(400).json({ message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });

    const isPasswordCorrect = await bcrypt.compare(password, user.password);
    if (!isPasswordCorrect) return res.status(400).json({ message: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ' });

    // âœ… Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² ÑÐµÑÑÐ¸Ð¸
    req.session.userId = user._id;
    req.session.user = {
      username: user.username,
      email: user.email,
      role: user.role
    };

    console.log("âœ… Ð’Ñ…Ð¾Ð´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½:", req.session);

    res.status(200).json({
      success: true,
      user: req.session.user
    });
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ…Ð¾Ð´Ðµ:', err);
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// === Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð° === //
app.post('/api/products', upload.single('image'), async (req, res) => {
  try {
    const userId = req.session.userId;
    if (!userId) {
      return res.status(403).json({ message: 'ÐÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½' });
    }

    const user = await User.findById(userId);
    if (!user || user.role !== 'admin') {
      return res.status(403).json({ message: 'Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½ Ð¼Ð¾Ð¶ÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹' });
    }

    const { name, article, price, description, properties, category } = req.body;

    const parsedPrice = parseFloat(price);
    if (isNaN(parsedPrice)) {
      return res.status(400).json({ message: 'Ð¦ÐµÐ½Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼' });
    }

    const parsedProperties = properties
      ? properties.split(',').map(p => p.trim()).filter(Boolean)
      : [];

    const image = req.file ? `/api/uploads/${req.file.filename}` : '/api/uploads/default.png';

    const newProduct = new Product({
      name,
      article,
      price: parsedPrice,
      description: description || '',
      properties: parsedProperties,
      category,
      image
    });

    await newProduct.save();
    res.status(201).json({ message: 'Ð¢Ð¾Ð²Ð°Ñ€ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½' });
  } catch (err) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð°:', err);
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// === ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² === //
app.get("/api/products", async (req, res) => {
  const { article } = req.query;

  if (article) {
    try {
      const product = await Product.findOne({ article: article.toString() });

      if (!product) {
        return res.status(404).json({ message: "Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" });
      }

      return res.json([product]); // âœ… ÐžÐ±Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð² Ð¼Ð°ÑÑÐ¸Ð²
    } catch (err) {
      console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð¸ÑÐºÐ° Ð¿Ð¾ Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ»Ñƒ:", err);
      return res.status(500).json([]);
    }
  }

  try {
    const products = await Product.find().exec();
    res.json(products);
  } catch (err) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²:", err);
    res.status(500).json([]);
  }
});

// === ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑÑÐ¸Ð¸ === //
app.get('/api/session', (req, res) => {
  console.log("SESSION:", req.session); // ðŸŽ¯ ÐžÑ‚Ð»Ð°Ð´ÐºÐ°
  res.json({
    session: req.session,
    user: req.session.user || 'ÐÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½',
    userId: req.session.userId || null
  });
});

// === ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð² (Ð°Ð´Ð¼Ð¸Ð½) === //
app.get('/api/orders', async (req, res) => {
  try {
    const userId = req.session.userId;
    if (!userId) return res.status(403).json({ message: 'ÐÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½' });

    const user = await User.findById(userId);
    if (!user || user.role !== 'admin') {
      return res.status(403).json({ message: 'Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ñ€Ð¾ÑÐ¼Ð°Ñ‚Ñ€Ð¸Ð²Ð°Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·Ñ‹' });
    }

    const orders = await Order.find().populate('userId', 'username email role').exec();
    res.status(200).json(orders);
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð¾Ð²:', err);
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

app.post("/api/orders", async (req, res) => {
  const { fullName, address, phone, email, deliveryMethod, paymentMethod, items } = req.body;

  if (!fullName || !address || !phone || !email || !deliveryMethod || !paymentMethod || !Array.isArray(items)) {
    return res.status(400).json({ message: "ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ…" });
  }

  const userId = req.session.userId;
  if (!userId) {
    return res.status(403).json({ message: "Ð’Ñ‹ Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ‹" });
  }

  let total = 0;

  // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸Ð· Ð±Ð°Ð·Ñ‹
  const products = await Product.find({ _id: { $in: items.map(i => i.productId) } });

  const orderItems = items.map(item => {
    const product = products.find(p => p._id.toString() === item.productId);
    if (!product) return null;

    const quantity = item.quantity || 1;
    total += product.price * quantity;

    return {
      productId: item.productId,
      name: product.name,
      price: product.price,
      quantity
    };
  }).filter(Boolean);

  if (orderItems.length === 0) {
    return res.status(400).json({ message: "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ ID Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²" });
  }

  const newOrder = new Order({
    userId,
    products: orderItems,
    totalAmount: total,
    status: "Ð¡Ð¾Ð±Ñ€Ð°Ð½",
    createdAt: new Date()
  });

  try {
    await newOrder.save();
    res.status(201).json({ message: "Ð—Ð°ÐºÐ°Ð· Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½", order: newOrder });
  } catch (err) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°:", err);
    res.status(500).json({ message: "ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°" });
  }
});

app.get("/api/orders", async (req, res) => {
  try {
    const orders = await Order.find().populate("userId", "username email role").exec();
    res.status(200).json(orders);
  } catch (err) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð²:", err);
    res.status(500).json([]);
  }
});

app.put("/api/orders/:id", async (req, res) => {
  const { status } = req.body;
  const orderId = req.params.id;

  try {
    const order = await Order.findByIdAndUpdate(orderId, { status }, { new: true });
    if (!order) return res.status(404).json({ message: "Ð—Ð°ÐºÐ°Ð· Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" });

    res.status(200).json({ message: "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½", order });
  } catch (err) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°:", err);
    res.status(500).json({ message: "ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°" });
  }
});

// === ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð¿Ð¾ ID === //
app.get('/api/products/:id', async (req, res) => {
  const { id } = req.params;
  try {
    const product = await Product.findById(id);
    if (!product) return res.status(404).json({ message: 'Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
    res.status(200).json(product);
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð°:', err);
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// === ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ²Ð¾Ð¸Ñ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð² (Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ) === //
app.get('/api/user/orders', async (req, res) => {
  const user = await User.findById(req.session.userId);
  if (!user) return res.status(403).json({ message: 'ÐÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½' });

  try {
    const orders = await Order.find({ userId: user._id });
    res.status(200).json(orders);
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð¾Ð²:', err);
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// === ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ === //
app.get('/api/users', async (req, res) => {
  try {
    const users = await User.find();
    res.status(200).json(users);
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹:', err);
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// === Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ === //
app.delete('/api/users/:id', async (req, res) => {
  const { id } = req.params;
  try {
    const deletedUser = await User.findByIdAndDelete(id);
    if (!deletedUser) return res.status(404).json({ message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
    res.status(200).json({ message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ´Ð°Ð»ÐµÐ½' });
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', err);
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// === Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð° === //
app.delete('/api/products/:id', async (req, res) => {
  const { id } = req.params;
  try {
    const deletedProduct = await Product.findByIdAndDelete(id);
    if (!deletedProduct) {
      return res.status(404).json({ message: 'Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
    }
    res.status(200).json({ message: 'âœ… Ð¢Ð¾Ð²Ð°Ñ€ ÑƒÐ´Ð°Ð»ÐµÐ½' });
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð°:', err);
    res.status(500).json({ message: 'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// === ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð² Ð´Ð»Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° === //
app.get('/api/reviews', async (req, res) => {
  const { productId } = req.query;
  if (!productId) return res.status(400).json([]);

  try {
    const reviews = await Review.find({ productId }).exec();
    res.json(reviews);
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²:', err);
    res.status(500).json([]);
  }
});

// === Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð·Ñ‹Ð²Ð° === //
app.post('/api/reviews', async (req, res) => {
  const { productId, rating, text } = req.body;
  if (!productId || !text) {
    return res.status(400).json({ message: 'ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ…' });
  }

  try {
    const newReview = new Review({ productId, rating, text });
    await newReview.save();
    res.status(201).json(newReview);
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð·Ñ‹Ð²Ð°:', err);
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
  }
});

// === Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° === //
app.listen(port, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° http://localhost:${port}`);
});